<div class="banner">
  <div class="banner-content-wrapper">
    <hgroup>
      <h1>aBBi</h1>
      <p role="doc-subtitle">AI-generated image descriptions</p>
    </hgroup>
    <img src="/assets/images/SLS_logo_symbol_black_112x112.png" alt="SLS logo">
  </div>
</div>

<div class="main-wrapper">
  <div class="intro-wrapper">
    <p>aBBi (“AI-bildbeskrivningar”) is a web app for generating image descriptions (e.g. alt texts) using AI.</p>
    <p>Start by defining your parameters for the process, then select image files from your computer, and finally generate descriptions for them. You can download the descriptions as a CSV-file or copy them to the clipboard individually.</p>
  </div>

  <mat-stepper orientation="vertical" [linear]="true" #stepper>
    <mat-step label="Configure AI-model settings">
      <mat-form-field appearance="outline">
        <mat-label>AI-model</mat-label>
        <mat-select [(ngModel)]="selectedModel" name="model">
          @for (model of availableModels; track model.id) {
            <mat-option [value]="model">{{model.provider}} {{model.name}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <div>
        <button mat-button matStepperNext>Next</button>
      </div>
    </mat-step>

    <mat-step label="Configure image description settings">
      <div class="parameters-wrapper">   
        <div class="form-field-wrapper">
          <mat-form-field appearance="outline">
            <mat-label>Description language</mat-label>
            <mat-select [(ngModel)]="selectedLanguage" name="language">
              <mat-option value="sv">Svenska</mat-option>
              <mat-option value="fi">Suomi</mat-option>
              <mat-option value="en">English</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
    
        <div class="form-field-wrapper">
          <div class="slider-wrapper">
            <div class="slider-label-wrapper">
              <label id="slider-label" class="slider-label">Description length:</label>
              <label class="slider-value-label">{{descLengthSlider.value}} characters</label>
            </div>
            <mat-slider
                [max]="descLengthMax"
                [min]="descLengthMin"
                [step]="25"
                [discrete]="true"
                [showTickMarks]="true"
            >
              <input matSliderThumb [(ngModel)]="selectedDescLength" #descLengthSlider>
            </mat-slider>
          </div>
        </div>
    
        <div class="form-field-wrapper">
          <mat-form-field appearance="outline">
            <mat-label>Prompt template</mat-label>
            <mat-select [(ngModel)]="selectedPromptTemplate" name="promptTemplate">
              <mat-option value="altText">Alt text</mat-option>
              <mat-option value="metadata">Metadata</mat-option>
            </mat-select>
          </mat-form-field>
          <button class="adj-button" mat-stroked-button>Edit prompt</button>
        </div>
      </div>
      <div>
        <button mat-button matStepperPrevious>Back</button>
        <button mat-button matStepperNext>Next</button>
      </div>
    </mat-step>

    <mat-step [stepControl]="apiKeyFormGroup">
      <form [formGroup]="apiKeyFormGroup">
        <ng-template matStepLabel>Enter your {{ selectedModel?.provider || '' }} API key</ng-template>
        <div class="form-field-wrapper">
          <mat-form-field appearance="outline">
            <mat-label>Your API key</mat-label>
            <input matInput required
                  [type]="hideApiKey ? 'password' : 'text'"
                  formControlName="apiKeyFC"
                  (change)="updateApiKey($event)"
            >
            <button mat-icon-button matSuffix (click)="hideApiKey = !hideApiKey" [attr.aria-label]="'Hide API key'" [attr.aria-pressed]="hideApiKey">
              <mat-icon>{{hideApiKey ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            @if (apiKeyFormGroup.invalid) {
              <mat-error>You must enter an API key</mat-error>
            }
          </mat-form-field>
          <file-input
                label="Load from file (TXT)"
                acceptedFileTypes="text/plain"
                appearence="stroked"
                (filesSelected)="loadApiKeyFromFile($event)"
          ></file-input>
          @if (!apiKey && apiError) {
            <span class="form-field-error">You must enter a valid API key</span>
          }
        </div>
        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext>Next</button>
        </div>
      </form>
    </mat-step>

    <mat-step>
      <ng-template matStepLabel>Done</ng-template>
      <p>{{apiKeyFC?.value}}</p>
      <div>
        <button mat-button matStepperPrevious>Back</button>
        <button mat-button (click)="stepper.reset()">Reset</button>
      </div>
    </mat-step>
  </mat-stepper>

  @if (apiKey) {
    <mat-card>
      <mat-card-content>
        <h2>3. Select images</h2>
        <div class="image-select-wrapper">
          <file-input
                label="Add image files (JPG, PNG)"
                acceptedFileTypes="image/png, image/jpeg"
                [multiple]="true"
                (filesSelected)="addImageFiles($event)"
          ></file-input>
          @if (addingImages || true) {
          <div class="progress-wrapper">
            <mat-label>Progress:</mat-label>
            <mat-progress-bar mode="determinate" [value]="addImagesProgress"></mat-progress-bar>
            <span>{{ addImagesProgress }} %</span>
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
  }

  @if (apiKey && imageFiles.length) {
    <mat-card>
      <mat-card-content>
        <h2>4. Generate image descriptions</h2>
        <div class="generate-desc-wrapper">
          <div class="buttons-row">
            <button mat-flat-button color="primary" [disabled]="generating">Generate all ({{ imageFiles.length }} {{ imageFiles.length > 1 ? 'images' : 'image' }})</button>
            <div class="export-buttons">
              <button mat-stroked-button [disabled]="generating">Export (CSV)</button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th scope="col">Image preview</th>
                <th scope="col">Generated description</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
            @for (file of imageFiles; track file?.filename) {
              <tr>
                <td class="preview-img">
                  <img [src]="file.base64Image" [height]="file.height" [width]="file.width">
                  <span class="filename">{{ file.filename }}</span>
                </td>
                <td class="description">
                  @if (file.generating) {
                    <span class="loading-wrapper">
                      <mat-spinner [diameter]="32"></mat-spinner><span class="spinner-label">Generating image description ...</span>
                    </span>
                  } @else if (!file.description) {
                    <span class="not-generated">No description generated yet.</span>
                  } @else {
                    {{ file.description }}
                  }
                </td>
                <td class="actions">
                  <button mat-stroked-button (click)="generateImageDescription(file)" [disabled]="generating" [innerHTML]="file.description ? 'Regenerate' : 'Generate'"></button>
                  <button mat-stroked-button [cdkCopyToClipboard]="file.description" [disabled]="generating || !file.description">Copy</button>
                  <button mat-stroked-button color="warn" (click)="removeImage(file)" [disabled]="generating">Remove image</button>
                </td>
              </tr>
            }
            </tbody>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
